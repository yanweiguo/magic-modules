<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Run provider tests locally # Note: If you want to test changes you&rsquo;ve made in Magic Modules, you need to first generate the provider you want to test. Setup # Authentication is described in more detail here.
Tests generally assume the following environment variables must be set in order to run tests:
GOOGLE_PROJECT GOOGLE_CREDENTIALS|GOOGLE_CLOUD_KEYFILE_JSON|GCLOUD_KEYFILE_JSON|GOOGLE_USE_DEFAULT_CREDENTIALS GOOGLE_REGION GOOGLE_ZONE Note that the credentials you provide must be granted wide permissions on the specified project."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Run provider tests"><meta property="og:description" content="Run provider tests locally # Note: If you want to test changes you&rsquo;ve made in Magic Modules, you need to first generate the provider you want to test. Setup # Authentication is described in more detail here.
Tests generally assume the following environment variables must be set in order to run tests:
GOOGLE_PROJECT GOOGLE_CREDENTIALS|GOOGLE_CLOUD_KEYFILE_JSON|GCLOUD_KEYFILE_JSON|GOOGLE_USE_DEFAULT_CREDENTIALS GOOGLE_REGION GOOGLE_ZONE Note that the credentials you provide must be granted wide permissions on the specified project."><meta property="og:type" content="article"><meta property="og:url" content="https://googlecloudplatform.github.io/magic-modules/get-started/run-provider-tests/"><meta property="article:section" content="get-started"><meta property="article:modified_time" content="2023-06-13T14:59:51-07:00"><title>Run provider tests | Magic Modules</title><link rel=manifest href=/magic-modules/manifest.json><link rel=icon href=/magic-modules/favicon.png type=image/x-icon><link rel=stylesheet href=/magic-modules/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/magic-modules/flexsearch.min.js></script>
<script defer src=/magic-modules/en.search.min.ff25816f010134906491c7aaf381ab20fa9c3d3b852fa03fddcbf43bc06cccd3.js integrity="sha256-/yWBbwEBNJBkkceq84GrIPqcPTuFL6A/3cv0O8BszNM=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/magic-modules/><img src=/magic-modules/magic-modules.svg alt=Logo><span>Magic Modules</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/magic-modules/>Overview</a></li></ul><ul><li><span>Get started</span><ul><li><a href=/magic-modules/get-started/generate-providers/>Generate the providers</a></li><li><a href=/magic-modules/get-started/how-magic-modules-works/>How Magic Modules works</a></li><li><a href=/magic-modules/get-started/run-provider-tests/ class=active>Run provider tests</a></li><li><a href=/magic-modules/get-started/use-built-provider/>Use built provider</a></li><li><a href=/magic-modules/get-started/contributing/>Contributing</a></li><li><a href=/magic-modules/get-started/provider-documentation/>Provider documentation</a></li></ul></li><li><span>Develop</span><ul><li><a href=/magic-modules/develop/resource/>Add or modify a resource</a></li><li><a href=/magic-modules/develop/add-mmv1-test/>Add an MMv1 test</a></li><li><a href=/magic-modules/develop/add-handwritten-test/>Add a handwritten test</a></li><li><a href=/magic-modules/develop/add-handwritten-datasource/>Add a datasource</a></li><li><a href=/magic-modules/develop/add-handwritten-datasource-documentation/>Add datasource documentation</a></li><li><a href=/magic-modules/develop/promote-to-ga/>Promote to GA</a></li><li><a href=/magic-modules/develop/make-a-breaking-change/>Make a breaking change</a></li></ul></li><li><a href=/magic-modules/best-practices/>Best practices</a><ul></ul></li><li><span>Contribute</span><ul><li><a href=/magic-modules/contribute/release-notes/>Write release notes</a></li><li><a href=/magic-modules/contribute/review-pr/>Review a PR</a></li></ul></li><li><span>Reference</span><ul><li><a href=/magic-modules/reference/make-commands/>make commands</a></li><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource.rb target=_blank rel=noopener>Resource YAML reference ↗</a></li><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/type.rb target=_blank rel=noopener>Field YAML reference ↗</a></li><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource/iam_policy.rb target=_blank rel=noopener>IAM policy YAML reference ↗</a></li><li><a href=/magic-modules/reference/breaking-change-detector/>Breaking change detector</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/magic-modules/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Run provider tests</strong>
<label for=toc-control><img src=/magic-modules/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#setup>Setup</a></li><li><a href=#run-unit-tests>Run unit tests</a></li><li><a href=#run-acceptance-tests>Run acceptance tests</a></li><li><a href=#debugging-tests>Debugging tests</a></li><li><a href=#testing-with-different-terraform-versions>Testing with different <code>terraform</code> versions</a></li></ul></nav></aside></header><article class=markdown><h1 id=run-provider-tests-locally>Run provider tests locally
<a class=anchor href=#run-provider-tests-locally>#</a></h1><blockquote class="book-hint info"><strong>Note:</strong> If you want to test changes you&rsquo;ve made in Magic Modules, you need to first <a href=/magic-modules/docs/getting-started/generate-providers/>generate</a> the provider you want to test.</blockquote><h2 id=setup>Setup
<a class=anchor href=#setup>#</a></h2><p>Authentication is described in more detail <a href=https://github.com/hashicorp/terraform-provider-google/wiki/Developer-Best-Practices#authentication>here</a>.</p><p>Tests generally assume the following environment variables must be set in order to run tests:</p><pre tabindex=0><code>GOOGLE_PROJECT
GOOGLE_CREDENTIALS|GOOGLE_CLOUD_KEYFILE_JSON|GCLOUD_KEYFILE_JSON|GOOGLE_USE_DEFAULT_CREDENTIALS
GOOGLE_REGION
GOOGLE_ZONE
</code></pre><p>Note that the credentials you provide must be granted wide permissions on the specified project. These tests provision real resources, and require permission in order to do so. Most developers on the team grant their test service account <code>roles/editor</code> or <code>roles/owner</code> on their project. Additionally, to ensure that your tests are performed in a region and zone with wide support for GCP features, <code>GOOGLE_REGION</code> should be set to <code>us-central1</code> and <code>GOOGLE_ZONE</code> to <code>us-central1-a</code>.</p><p>Additional variable may be required for other tests, and should get flagged when running them by Go skipping the test and flagging in the output it was skipped, with a skip message explaining why. The most typical extra values required are those required for project creation:</p><pre tabindex=0><code>GOOGLE_ORG
GOOGLE_BILLING_ACCOUNT
</code></pre><h2 id=run-unit-tests>Run unit tests
<a class=anchor href=#run-unit-tests>#</a></h2><p>Unit tests (that is, tests that do not interact with the GCP API) are very fast and you can generally run them all if you have changed any of them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># for ga provider</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google
</span></span><span style=display:flex><span>make test
</span></span><span style=display:flex><span>make lint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># for beta provider</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google-beta
</span></span><span style=display:flex><span>make test
</span></span><span style=display:flex><span>make lint
</span></span></code></pre></div><h2 id=run-acceptance-tests>Run acceptance tests
<a class=anchor href=#run-acceptance-tests>#</a></h2><p>You can run tests against the provider you generated in the <code>OUTPUT_PATH</code> location. When running tests, specify which to run using <code>TESTARGS</code>, such as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># for ga provider</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google
</span></span><span style=display:flex><span>make testacc TEST<span style=color:#f92672>=</span>./google TESTARGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-run=TestAccContainerNodePool_basic&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># for beta provider</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google-beta
</span></span><span style=display:flex><span>make testacc TEST<span style=color:#f92672>=</span>./google-beta TESTARGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-run=TestAccContainerNodePool_basic&#39;</span>
</span></span></code></pre></div><p>TESTARGS allows you to pass <a href=https://pkg.go.dev/cmd/go#hdr-Testing_flags>testing flags</a> to <code>go test</code>. The most important is <code>-run</code>, which allows you to limit the tests that get run. There are 2000+ tests, and running all of them takes over 9 hours and requires a lot of GCP quota.</p><p><code>-run</code> is regexp-like, so multiple tests can be run in parallel by specifying a common substring of those tests (for example, <code>TestAccContainerNodePool</code> to run all node pool tests).</p><h2 id=debugging-tests>Debugging tests
<a class=anchor href=#debugging-tests>#</a></h2><p>You can <a href=https://www.terraform.io/docs/internals/debugging.html>increase your test verbosity</a> and redirect the output to a log file for analysis. This is often helpful in debugging issues.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># for ga provider</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google
</span></span><span style=display:flex><span>TF_LOG<span style=color:#f92672>=</span>TRACE make testacc TEST<span style=color:#f92672>=</span>./google TESTARGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-run=TestAccContainerNodePool_basic&#39;</span> &gt; output.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># for beta provider</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google-beta
</span></span><span style=display:flex><span>TF_LOG<span style=color:#f92672>=</span>TRACE make testacc TEST<span style=color:#f92672>=</span>./google-beta TESTARGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-run=TestAccContainerNodePool_basic&#39;</span> &gt; output.log
</span></span></code></pre></div><p>You can also debug tests with <a href=https://github.com/go-delve/delve>Delve</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Navigate to the google package within your local GCP Terraform provider Git clone.</span>
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/terraform-providers/terraform-provider-google/google
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Execute the dlv command to launch the test.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note that the --test.run flag uses the same regexp matching as go test --run.</span>
</span></span><span style=display:flex><span>TF_ACC<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> dlv test -- --test.v --test.run TestAccComputeRegionBackendService_withCdnPolicy
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#39;help&#39;</span> <span style=color:#66d9ef>for</span> list of commands.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>dlv<span style=color:#f92672>)</span> b google.TestAccComputeRegionBackendService_withCdnPolicy
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> set at 0x1de072b <span style=color:#66d9ef>for</span> github.com/terraform-providers/terraform-provider-google/google.TestAccComputeRegionBackendService_withCdnPolicy<span style=color:#f92672>()</span> ./resource_compute_region_backend_service_test.go:540
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>dlv<span style=color:#f92672>)</span> c
</span></span><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestAccComputeRegionBackendService_withCdnPolicy
</span></span><span style=display:flex><span>&gt; github.com/terraform-providers/terraform-provider-google/google.TestAccComputeRegionBackendService_withCdnPolicy<span style=color:#f92672>()</span> ./resource_compute_region_backend_service_test.go:540 <span style=color:#f92672>(</span>hits goroutine<span style=color:#f92672>(</span>7<span style=color:#f92672>)</span>:1 total:1<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>PC: 0x1de072b<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   535:                         <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>   536:                 <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>   537:         <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>   538: <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   539:
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>&gt; 540: func TestAccComputeRegionBackendService_withCdnPolicy<span style=color:#f92672>(</span>t *testing.T<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   541:         t.Parallel<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>   542:
</span></span><span style=display:flex><span>   543:         var svc compute.BackendService
</span></span><span style=display:flex><span>   544:         resource.Test<span style=color:#f92672>(</span>t, resource.TestCase<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   545:                 PreCheck:     func<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> acctest.AccTestPreCheck<span style=color:#f92672>(</span>t<span style=color:#f92672>)</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>dlv<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=testing-with-different-terraform-versions>Testing with different <code>terraform</code> versions
<a class=anchor href=#testing-with-different-terraform-versions>#</a></h2><p>Tests will use whatever version of the <code>terraform</code> binary is found on your path. To test with multiple versions of <code>terraform</code> core, you must run the tests multiple times with different versions. You can use <a href=https://github.com/tfutils/tfenv><code>tfenv</code></a> to manage your system <code>terraform</code> versions.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/commit/6ec6e62f1a10cd70b6cd6f495b1e241598ec471c title='Last modified by Stephen Lewis (Burrows) | June 13, 2023' target=_blank rel=noopener><img src=/magic-modules/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 13, 2023</span></a></div><div><a class="flex align-center" href="https://github.com/hashicorp/terraform-provider-google/issues/new?assignees=&labels=technical-debt,documentation&projects=&title=MM%20docsite%20issue%20in%20content/get-started%2frun-provider-tests.md&template=11_developer_productivity.md" target=_blank rel=noopener><img src=/magic-modules/report.svg class=book-icon alt=Edit>
<span>Report documentation issue</span></a></div><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/edit/main/docs/content/get-started/run-provider-tests.md target=_blank rel=noopener><img src=/magic-modules/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#setup>Setup</a></li><li><a href=#run-unit-tests>Run unit tests</a></li><li><a href=#run-acceptance-tests>Run acceptance tests</a></li><li><a href=#debugging-tests>Debugging tests</a></li><li><a href=#testing-with-different-terraform-versions>Testing with different <code>terraform</code> versions</a></li></ul></nav></div></aside></main></body></html>